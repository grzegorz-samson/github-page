---
import LanguageSwitch from '../components/LanguageSwitch.astro';
import FundingFooter from '../components/FundingFooter.astro';
import PageViewTracker from '../components/PageViewTracker.astro';
import { withBase } from '../lib/paths';
import '../styles/global.css';

const { title, description = '', lang = 'pl' } = Astro.props;
const pageTitle = typeof title === 'string' && title.trim().length > 0 ? title.trim() : 'Greggular VST';
const pageDescription = typeof description === 'string' ? description.trim() : '';
const pageUrl = Astro.url.href;
const normalizePath = (value: string): string => {
  const normalized = value.replace(/\/+$/, '');
  return normalized.length > 0 ? normalized : '/';
};
const currentPath = normalizePath(Astro.url.pathname);

const labels =
  lang === 'pl'
    ? {
        project: 'Projekt',
        plugin: 'Wtyczka VST',
        research: 'Badania',
        workshops: 'Warsztaty',
        scholarship: 'Stypendium',
        bio: 'Bio'
      }
    : {
        project: 'Project',
        plugin: 'VST Plugin',
        research: 'Research',
        workshops: 'Workshops',
        scholarship: 'Scholarship',
        bio: 'Bio'
      };

const navItems =
  lang === 'pl'
    ? [
        { href: withBase('/pl/project/'), label: labels.project },
        { href: withBase('/pl/plugin/'), label: labels.plugin },
        { href: withBase('/pl/research/'), label: labels.research },
        { href: withBase('/pl/workshops/'), label: labels.workshops },
        { href: withBase('/pl/scholarship/'), label: labels.scholarship },
        { href: withBase('/pl/bio/'), label: labels.bio }
      ]
    : [
        { href: withBase('/en/project/'), label: labels.project },
        { href: withBase('/en/plugin/'), label: labels.plugin },
        { href: withBase('/en/research/'), label: labels.research },
        { href: withBase('/en/workshops/'), label: labels.workshops },
        { href: withBase('/en/scholarship/'), label: labels.scholarship },
        { href: withBase('/en/bio/'), label: labels.bio }
      ];

const footerText =
  lang === 'pl'
    ? 'Nowe technologie w rozwoju narzędzi i kompetencji technologicznych dla współczesnej muzyki'
    : 'New technologies in developing tools and technological competences for contemporary music';
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href={withBase('/favicon.svg')} />
    <link rel="icon" href={withBase('/favicon.ico')} />
    <title>{pageTitle}</title>
    {pageDescription && <meta name="description" content={pageDescription} />}
    <meta property="og:title" content={pageTitle} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={pageUrl} />
    {pageDescription && <meta property="og:description" content={pageDescription} />}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    {pageDescription && <meta name="twitter:description" content={pageDescription} />}
  </head>
  <body>
    <div class="site-bg"></div>
    <header class="main-header">
      <a class="brand" href={withBase(`/${lang}/`)}>GS</a>
      <nav>
        {navItems.map((item) => {
          const isCurrent = normalizePath(item.href) === currentPath;
          return (
            <a href={item.href} aria-current={isCurrent ? 'page' : undefined}>
              {item.label}
            </a>
          );
        })}
      </nav>
      <LanguageSwitch />
    </header>

    <main class="container">
      <slot />
    </main>

    <footer class="main-footer">
      <p>{footerText}</p>
      <p>09.2025 - 02.2026</p>
    </footer>
    <FundingFooter lang={lang} />
    <PageViewTracker lang={lang} />
    <script>
      const TYPOGRAPHY_ROOTS = ['main.container', '.funding-footer'];
      const TYPOGRAPHY_SKIP = new Set([
        'A',
        'BUTTON',
        'CODE',
        'INPUT',
        'KBD',
        'LABEL',
        'OPTION',
        'PRE',
        'SCRIPT',
        'SELECT',
        'STYLE',
        'TEXTAREA'
      ]);
      const HANGING_WORDS = ['a', 'i', 'o', 'u', 'w', 'z', 'na', 'do', 'od', 'po', 'za', 'we', 'ze'];
      const HANGING_PATTERN = new RegExp(`(^|[\\s([{"'“”„«»])(${HANGING_WORDS.join('|')})\\s+`, 'giu');

      const shouldSkipNode = (node) => {
        let current = node.parentElement;
        while (current) {
          if (TYPOGRAPHY_SKIP.has(current.tagName)) return true;
          current = current.parentElement;
        }
        return false;
      };

      const protectHangingWords = (value) =>
        value.replace(HANGING_PATTERN, (match, prefix, word) => `${prefix}${word}\u00A0`);

      const walkerFilter = {
        acceptNode(node) {
          if (!(node instanceof Text)) return NodeFilter.FILTER_REJECT;
          if (!node.textContent || !node.textContent.trim()) return NodeFilter.FILTER_REJECT;
          if (shouldSkipNode(node)) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      };

      const applyPolishTypography = () => {
        if (document.documentElement.lang !== 'pl') return;

        for (const selector of TYPOGRAPHY_ROOTS) {
          const root = document.querySelector(selector);
          if (!(root instanceof HTMLElement)) continue;

          const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, walkerFilter);
          const nodes = [];
          let currentNode = walker.nextNode();
          while (currentNode) {
            nodes.push(currentNode);
            currentNode = walker.nextNode();
          }

          for (const node of nodes) {
            const original = node.textContent ?? '';
            const updated = protectHangingWords(original);
            if (updated !== original) node.textContent = updated;
          }
        }
      };

      const runTypographyPass = () => {
        applyPolishTypography();
      };

      runTypographyPass();
    </script>
  </body>
</html>
